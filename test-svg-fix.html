<!DOCTYPE html>
<html>
<head>
    <title>SVG Parser Test</title>
    <script>
        // 从 svg-editor-context.tsx 复制的清理函数
        function aggressiveCleanup(svg) {
            let cleaned = svg;
            
            // 1. 移除注释
            cleaned = cleaned.replace(/<!--[\s\S]*?-->/g, '');
            
            // 2. 修复常见的属性错误
            cleaned = cleaned
                // 移除style标签中的背景色（通常会导致问题）
                .replace(/\s+style="[^"]*background-color:[^;"]*;?[^"]*"/gi, '');
            
            // 3. 修复未自闭合的单标签元素
            const selfClosingTags = [
                'rect', 'circle', 'ellipse', 'line', 'polyline', 'polygon',
                'path', 'image', 'use', 'stop', 'animate', 'animateTransform'
            ];
            
            selfClosingTags.forEach(tag => {
                // 修复1: 先处理已经有 /> 的标签，确保它们格式正确
                cleaned = cleaned.replace(
                    new RegExp(`<${tag}([^>]*?)\\s*/\\s*>`, 'gi'),
                    `<${tag}$1/>`
                );
                
                // 修复2: 先移除所有不正确的结束标签
                cleaned = cleaned.replace(
                    new RegExp(`</${tag}>`, 'gi'),
                    ''
                );
                
                // 然后添加自闭合到所有非自闭合的标签
                cleaned = cleaned.replace(
                    new RegExp(`<${tag}\\s+([^/>][^>]*)>`, 'gi'),
                    (match, attrs) => {
                        const trimmedAttrs = attrs.trim();
                        if (trimmedAttrs.endsWith('/')) {
                            return `<${tag} ${trimmedAttrs.slice(0, -1).trim()}/>`;
                        }
                        return `<${tag} ${trimmedAttrs}/>`;
                    }
                );
                
                // 处理没有属性的标签 <tag>
                cleaned = cleaned.replace(
                    new RegExp(`<${tag}>`, 'gi'),
                    `<${tag}/>`
                );
            });
            
            return cleaned;
        }

        function testSvgCleaning() {
            const problematicSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600" viewBox="0 0 800 600" style="background-color: #f8fafc;">
  <!-- Cat body -->
  <ellipse cx="400" cy="350" rx="120" ry="80" fill="#4b5563" stroke="#374151" stroke-width="2">
  
  <!-- Cat head -->
  <circle cx="400" cy="250" r="80" fill="#4b5563" stroke="#374151" stroke-width="2"></circle>
  
  <!-- Whiskers -->
  <line x1="300" y1="240" x2="350" y2="235" stroke="#374151" stroke-width="1.5">
  
  <!-- Laptop Base -->
  <rect x="320" y="380" width="160" height="10" fill="#94a3b8" stroke="#64748b" stroke-width="1.5" rx="2">
</svg>`;

            console.log("Original SVG:");
            console.log(problematicSvg);
            
            // 测试解析失败
            const parser = new DOMParser();
            const parsed1 = parser.parseFromString(problematicSvg, "image/svg+xml");
            const error1 = parsed1.querySelector("parsererror");
            
            document.getElementById('original-result').innerHTML = error1 
                ? `<span style="color: red;">❌ Parse Error</span><br><pre>${error1.textContent}</pre>` 
                : '<span style="color: green;">✅ Valid</span>';
            
            // 清理
            console.log("\n\nCleaning SVG...");
            const cleaned = aggressiveCleanup(problematicSvg);
            console.log("Cleaned SVG:");
            console.log(cleaned);
            
            document.getElementById('cleaned-svg').textContent = cleaned;
            
            // 测试清理后的解析
            const parsed2 = parser.parseFromString(cleaned, "image/svg+xml");
            const error2 = parsed2.querySelector("parsererror");
            
            document.getElementById('cleaned-result').innerHTML = error2 
                ? `<span style="color: red;">❌ Parse Error</span><br><pre>${error2.textContent}</pre>` 
                : '<span style="color: green;">✅ Valid - Successfully fixed!</span>';
            
            // 渲染SVG
            if (!error2) {
                document.getElementById('svg-preview').innerHTML = cleaned;
            }
        }
        
        window.onload = testSvgCleaning;
    </script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 {
            margin-top: 0;
        }
        pre {
            background: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        #svg-preview {
            border: 2px solid #ddd;
            padding: 20px;
            background: white;
            display: inline-block;
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>SVG Parser Fix Test</h1>
    
    <div class="section">
        <h2>1. Original SVG (with errors)</h2>
        <div id="original-result"></div>
    </div>
    
    <div class="section">
        <h2>2. Cleaned SVG</h2>
        <div id="cleaned-result"></div>
        <h3>Cleaned SVG Code:</h3>
        <pre id="cleaned-svg"></pre>
    </div>
    
    <div class="section">
        <h2>3. Rendered SVG</h2>
        <div id="svg-preview"></div>
    </div>
</body>
</html>
